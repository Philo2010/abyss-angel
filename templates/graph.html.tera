<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Scores Over Time</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        h2 {
            color: #555;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Team Performance Over Time</h1>
    
    <div id="chartsContainer"></div>

    <script>
        const data = {{ data | json_encode() | safe }};

        // Colors for different teams
        const colors = [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(255, 99, 71, 1)',
            'rgba(144, 238, 144, 1)'
        ];

        // Extract all categories (excluding Time)
        const categories = new Set();
        data.forEach(teamData => {
            const scores = teamData.slice(1);
            scores.forEach(score => {
                Object.keys(score).forEach(key => {
                    if (key !== 'Time') {
                        categories.add(key);
                    }
                });
            });
        });

        const categoryList = Array.from(categories);

        // Process data for each team
        const processedData = data.map((teamData, idx) => {
            const teamId = teamData[0];
            const scores = teamData.slice(1);
            
            return {
                teamId: teamId,
                color: colors[idx % colors.length],
                points: scores.map(score => ({
                    time: new Date(score.Time),
                    ...score
                })).sort((a, b) => a.time - b.time)
            };
        });

        // Find max number of submissions across all teams
        const maxSubmissions = Math.max(...processedData.map(team => team.points.length));

        // Create labels based on submission number
        const submissionLabels = Array.from({length: maxSubmissions}, (_, i) => `Submission ${i + 1}`);

        // Create datasets for a specific category
        function createDatasets(category) {
            return processedData.map(team => {
                // Map each team's submissions to their occurrence index
                const dataArray = team.points.map(point => point[category]);

                return {
                    label: `Team ${team.teamId}`,
                    data: dataArray,
                    timestamps: team.points.map(point => point.time), // Store timestamps for tooltips
                    borderColor: team.color,
                    backgroundColor: team.color.replace('1)', '0.1)'),
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                };
            });
        }

        // Chart configuration
        const chartConfig = (title, datasets) => ({
            type: 'line',
            data: {
                labels: submissionLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                                return null;
                            },
                            afterLabel: function(context) {
                                const timestamps = context.dataset.timestamps;
                                if (timestamps && timestamps[context.dataIndex]) {
                                    const time = new Date(timestamps[context.dataIndex]);
                                    return 'Time: ' + time.toLocaleString('en-US', {
                                        month: 'short',
                                        day: 'numeric',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    });
                                }
                                return null;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Submission Number'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: title
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Create charts dynamically for each category
        const container = document.getElementById('chartsContainer');
        
        categoryList.forEach(category => {
            // Create container div
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            // Create title
            const title = document.createElement('h2');
            title.textContent = category;
            chartDiv.appendChild(title);
            
            // Create chart wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            
            // Create canvas
            const canvas = document.createElement('canvas');
            const canvasId = 'chart-' + category.replace(/\s+/g, '-').toLowerCase();
            canvas.id = canvasId;
            wrapper.appendChild(canvas);
            
            chartDiv.appendChild(wrapper);
            container.appendChild(chartDiv);
            
            // Create chart
            new Chart(canvas, chartConfig(category, createDatasets(category)));
        });
    </script>
</body>
</html>